#+STARTUP: showall indent

* Fakeymacs extension - space_fn -

** ■ SpaceFN を実現する設定を行う

SpaceFN を実現する設定を行う拡張機能です。

Space キーを Fn キーとして、次のようなキーマップのレイヤーが利用可能となります。

[[/fakeymacs_extensions/space_fn/SpaceFN_layout/SpaceFN_layout.png]]

この設定は、次のサイトの設定例を参考としています。

- https://geekhack.org/index.php?topic=51069.0
- https://kbd.news/The-SpaceFN-concept-2315.html

*** 設定ファイル

SpaceFN のキー設定は、config_personal.py という名称のファイルで行います。
_config_personal_1.py もしくは _config_personal_2.py という名称のサンプル設定ファイルを
準備していますので、同じフォルダ上に config_personal.py というファイル名称で複製し、
設定を調整してご利用ください。

なお、２つのサンプル設定ファイルは上記のキーマップ図のとおりの設定を行っていますが、
青いキーについては以下のとおりの異なる設定としています。

_config_personal_1.py は、Ctrl キー、Alt キー、Win キーとの組み合わせも含め、
できるだけ完全なキーの複製を行うサンプルです。
_config_personal_2.py は、Ctrl キー、Alt キー、Win キーとの組み合わせは行わない、
キー単体と Shift キーの組み合わせのみのキーの複製を行うサンプルです。
SpaceFN は、設定を行っていない SpaceFN レイヤーのキーを入力すると、SpaceFN 用の
モディファイアキーを除いたキーを発行する機能を持っています。
そして本拡張機能の SpaceFN の場合は、Emacs キーバインドの機能ではなく、Windows
ショートカットキーの機能が実行される仕様としています。
この機能を活用することにより、SpaceFN 用のモディファイアキーを押してから Ctrl+x や Ctrl+c
などのキーを入力すると、Windows ショートカットキーの機能の「カット」や「コピー」などを
利用することができます。
HHKB US キーボードのように、Ctrl キーが一つしか持てない（CapsLock キーに RCtrl キーを
割当てられない）キーボードを使っている場合、有用な機能になるのではないかと思います。
（Fakeymacs には Windows ショートカットキーの機能を利用するために Ctrl+q を前置する
方法がありますが、本説明の機能では、１ストロークのキー操作を実現しています。）
_config_personal_2.py は、この機能を最大限に利用する（青いキーが押された場合でも、
Ctrl キー、Alt キー、Win キーとの組み合わせで押された場合には、元の配置のキーを使った
Windows ショートカットキーとして機能する）設定サンプルとなっています。

**** ● 設定の具体例

|-----------+-----------------------+-----------------------+----------------|
| Input key | _config_personal_1.py | _config_personal_2.py | Description    |
|-----------+-----------------------+-----------------------+----------------|
| U0-j      | Left                  | Left                  |                |
| U0-S-j    | S-Left                | S-Left                |                |
| U0-C-j    | C-Left                | C-j                   | 異なる設定箇所 |
| U0-A-j    | A-Left                | A-j                   | 異なる設定箇所 |
| U0-W-j    | W-Left                | W-j                   | 異なる設定箇所 |
|-----------+-----------------------+-----------------------+----------------|
| U0-a      | a                     | a                     |                |
| U0-S-a    | S-a                   | S-a                   |                |
| U0-C-a    | C-a                   | C-a                   |                |
| U0-A-a    | A-a                   | A-a                   |                |
| U0-W-a    | W-a                   | W-a                   |                |
|-----------+-----------------------+-----------------------+----------------|
| U0-1      | F1                    | F1                    |                |
| U0-S-1    | S-F1                  | S-F1                  |                |
| U0-C-1    | C-F1                  | C-F1                  |                |
| U0-A-1    | A-F1                  | A-F1                  |                |
| U0-W-1    | W-F1                  | W-F1                  |                |
|-----------+-----------------------+-----------------------+----------------|

- 「U0」は fc.space_fn_key 変数に設定した SpaceFN 用のモディファイアキー

*** コンフィグレーションパラメータ

|----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Configuration parameter          | Description                                                                                                                                                                                                             |
|----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| fc.space_fn_key                  | SpaceFN 用のモディファイアキーを指定する                                                                                                                                                                                |
| fc.space_fn_window_keymap_list   | SpaceFN を適用するキーマップを指定する                                                                                                                                                                                  |
| fc.space_fn_use_oneshot_function | SpaceFN 用のモディファイアキーの単押しで、元のキーの機能を利用するかどうかを指定する                                                                                                                                    |
| fc.space_fn_use_repeat_function  | SpaceFN 用のモディファイアキーの長押しで、元のキーのリピート入力を行うかどうかを指定する                                                                                                                                |
| fc.space_fn_function_time1       | SpaceFN 用のモディファイアキーが押されてから次のキーが押されるまでの時間で、SpaceFN の機能が必ず働くようになるまでの時間を秒数で指定する                                                                                |
| fc.space_fn_function_time2       | SpaceFN 用のモディファイアキーと別なキーが同時に押された場合、最後のキーが押されてから一定時間内に SpaceFN 用のモディファイアキーが離されたときは押されたキーをそのまま入力する仕様としており、その時間を秒数で指定する |
|----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

*** 関数（Functions）

**** ■ define_key_fn

キーマップに SpaceFN 用のキーを定義する

***** Function

#+BEGIN_EXAMPLE
def define_key_fn(window_keymap, keys, command, space_fn_key_output=False):
#+END_EXAMPLE

***** Parameters

|---------------------+----------------------------------------------------------------------------------------------|
| Parameter           | Description                                                                                  |
|---------------------+----------------------------------------------------------------------------------------------|
| window_keymap       | WindowKeymapオブジェクト                                                                     |
| keys                | SpaceFN 用に設定するキー（keys の初めのキーには U0- を含むこと）                             |
| command             | 実行するコマンド（関数）                                                                     |
| space_fn_key_output | command を実行する前に、fc.space_fn_key 変数に設定しているキーの出力をするかどうかを指定する |
|---------------------+----------------------------------------------------------------------------------------------|

***** Returns

- 無し

**** ■ replicate_key

SpaceFN 用にキーを複製する

***** Function

#+BEGIN_EXAMPLE
def replicate_key(window_keymap, key, original_key):
#+END_EXAMPLE

***** Parameters

|---------------+------------------------------------------------------------------|
| Parameter     | Description                                                      |
|---------------+------------------------------------------------------------------|
| window_keymap | WindowKeymapオブジェクト                                         |
| key           | SpaceFN 用に設定するキー（key の初めのキーには U0- を含むこと）  |
| original_key  | 複製する元のキー                                                 |
|---------------+------------------------------------------------------------------|

***** Returns

- 無し

*** サンプル設定ファイル（_config_personal-1.py、_config_personal-2.py）で設定しているキーバインド

**** ● SpaceFN 主要キーの設定

|-------------+-----------------+--------------------------|
| Keybind     | replacement key | Description              |
|-------------+-----------------+--------------------------|
| U0-<m>-j    | <m>-Left        |                          |
| U0-<m>-l    | <m>-Right       |                          |
| U0-<m>-i    | <m>-Up          |                          |
| U0-<m>-k    | <m>-Down        |                          |
| U0-<m>-u    | <m>-Home        |                          |
| U0-<m>-o    | <m>-End         |                          |
| U0-<m>-h    | <m>-PageUp      |                          |
| U0-<m>-n    | <m>-PageDown    |                          |
| U0-<m>-Esc  | <m>-`           |                          |
| U0-<m>-Back | <m>-Delete      |                          |
| U0-<m>-p    | <m>-PrintScreen |                          |
| U0-<m>-[    | <m>-ScrollLock  |                          |
| U0-<m>-]    | <m>-Pause       |                          |
| U0-<m>-\    | <m>-Insert      |                          |
| U0-<m>-b    | <m>-Space       | スペースの連続入力が可能 |
| U0-<m>-/    | <m>-Apps        |                          |
|-------------+-----------------+--------------------------|

- 「U0」は fc.space_fn_key 変数に設定した SpaceFN 用のモディファイアキー
- _config_personal-1.py のサンプル設定では、<m> は 空、W、A、C、S の全ての組み合わせパターン
- _config_personal-2.py のサンプル設定では、<m> は 空 か S のどちらかのパターン

**** ● ファンクションキーの設定

|-----------------------------+-----------------+-------------|
| Keybind                     | replacement key | Description |
|-----------------------------+-----------------+-------------|
| U0-<m>-1                    | <m>-F1          |             |
| U0-<m>-2                    | <m>-F2          |             |
| U0-<m>-3                    | <m>-F3          |             |
| U0-<m>-4                    | <m>-F4          |             |
| U0-<m>-5                    | <m>-F5          |             |
| U0-<m>-6                    | <m>-F6          |             |
| U0-<m>-7                    | <m>-F7          |             |
| U0-<m>-8                    | <m>-F8          |             |
| U0-<m>-9                    | <m>-F9          |             |
| U0-<m>-0                    | <m>-F10         |             |
| U0-<m>-<上記の右隣のキー>   | <m>-F11         |             |
| U0-<m>-<上記の右隣のキー>   | <m>-F12         |             |
|-----------------------------+-----------------+-------------|

- 「U0」は fc.space_fn_key 変数に設定した SpaceFN 用のモディファイアキー
- <m> は 空、W、A、C、S の全ての組み合わせパターン

*** 留意事項

● 本拡張機能では、SpaceFN 用のモディファイアキーとして LUser0 を利用しているほか、
内部で RUser0 を利用しています。
このため、User0 のユーザモディファイアキーは利用者側で定義しないようにしてください。

● 本拡張機能の SpaceFN は、初期値として keymap_emacs と keymap_lw のキーマップのみで
動作するようにしています。
Emacs 日本語入力モードを利用している場合、日本語入力時（keymap_ei キーマップ移行時）には
SpaceFN の機能が無効となることにご留意ください。
fc.space_fn_window_keymap_list 変数の指定ににより、SpaceFN を適用するキーマップを
変更することができます。

● 本拡張機能の SpaceFN は、SpaceFN 用のモディファイアキーが押されてから
fc.space_fn_function_time1 変数に指定した秒数（初期値：0.2秒）より前に次のキーが押され、
かつ最後のキーが押されてから fc.space_fn_function_time2 変数に指定した秒数（初期値：0.1秒）
内に SpaceFN 用のモディファイアキーが離された場合に、押されたキーがそのまま入力される仕様
としています。（key rollover の対策です。）

● 本拡張機能の SpaceFN を利用する場合は、必ず SpaceFN 用のモディファイアキー（初期値は
Space）から入力するようにしてください。本拡張機能の SpaceFN は、Shift や Ctrl などその他の
モディファイアキーと組み合わせて利用することもできますが、その他のモディファイアキーを
最初に入力した場合には、SpaceFN 用のモディファイアキーを入力した時点でキーの入力が
確定する仕様としています。（これは、Ctrl+Space や Shift+Space を遅延なく入力できるように
する対策です。）

● fc.space_fn_use_repeat_function 変数の初期値（2）では、SpaceFN 用のモディファイアキー
を一度単押ししたあとに長押しすると、元のキーのリピート入力ができるようになります。
単押し無しでリピート入力する設定値（1）やリピート入力自体を行わない設定値（3）を選択する
こともできます。

● 本拡張機能の設定を行うと、設定を行わない場合より Keyhac のコンソールに
「Time stamp inversion happened.」という表示がより頻度高く表示されるようになります。
これは、以下のページの留意事項の最後に記載しているとおり、レジストリの設定変更である程度の
回避はできるようです。ただし、この設定により生ずる影響は分かっていませんので、試す場合は
各自の責任でお願いします。

- https://github.com/smzht/fakeymacs?tab=readme-ov-file#%E7%95%99%E6%84%8F%E4%BA%8B%E9%A0%85

● 本拡張機能の特徴については、次の issue にも記載しています。

- https://github.com/smzht/fakeymacs/issues/30

*** その他

● 本拡張機能でカーソルキーを利用する場合、ブラウザのウェブコンテンツのスクロールで利用する
場面が多いように思います。ただし、アドレスバーなどウェブコンテンツ以外の場所にフォーカスが
ある場合には、まずウェブコンテンツにフォーカスを移動する必要があります。この操作は、Chromium
系ブラウザでは、Ctrl+F6 キーの入力により対応可能です。そして、本拡張機能の初期設定では、
Space+Ctrl+6 キーにそのキーが割り当てられています。

● 本拡張機能の SpaceFN は、SpaceFN キーへのマルチストロークキーの割当てに対応しています。
SpaceFN キーをマルチストロークキーとして利用する場合のサンプルコードは、次のようなものとなります。
（マルチストロークキーを設定する際も、define_key_fn 関数を利用していることにご留意ください。）

#+BEGIN_EXAMPLE
define_key_fn(keymap_emacs, "U0-d", keymap.defineMultiStrokeKeymap("U0-d"))

def kill_line2(repeat):
    move_beginning_of_line()
    kill_line(repeat, kill_whole_line=True)

# Vim の一行削除をイメージ
define_key_fn(keymap_emacs, "U0-d U0-d",
              lambda: keymap.delayedCall(
                  reset_search(reset_undo(reset_counter(reset_mark(repeat3(kill_line2))))), 50))

# 数引数のサポート
for n in range(10):
    define_key_fn(keymap_emacs, f"U0-{n}", digit2(n))
#+END_EXAMPLE

※ SpaceFN 用のモディファイアキーを使ったマルチストロークキーを利用する際には、マルチストローク
キーの１番目のキーが確定してから次のキーを押す必要があります。
これは、key rollover の対策を行っていることによって生ずる制約となりますので、ご留意ください。
